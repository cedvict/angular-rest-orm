/**
 * Angular ORM for HTTP REST APIs
 * @version angular-rest-orm - v0.2.1 - 2014-08-28
 * @link https://github.com/panta/angular-rest-orm
 * @author Marco Pantaleoni <marco.pantaleoni@gmail.com>
 *
 * Copyright (c) 2014 Marco Pantaleoni <marco.pantaleoni@gmail.com>
 * Licensed under the MIT License, http://opensource.org/licenses/MIT
 */
var __hasProp={}.hasOwnProperty;angular.module("restOrm",[]).factory("Resource",["$http","$q",function(a,b){var c;return c=function(){function c(a,b){null==a&&(a=null),null==b&&(b={}),this.$meta={persisted:!1},angular.extend(this.$meta,b),this.$id=null,this._fromObject(a||{}),this.$promise=null,this.$promiseDirect=null,this._setupPromises(),this._fetchRelations(),null!=this.$initialize&&this.$initialize()}return c.urlPrefix="",c.urlEndpoint="",c.idField="id",c.defaults={},c.references=[],c.m2m=[],c.prototype.$initialize=function(){return this},c.Create=function(a){var b;return null==a&&(a=null),a=a||this.defaults,b=new this(a,{persisted:!1}),b.$save(),b},c.Get=function(b){var c;return c=new this,a({method:"GET",url:this._GetURLBase()+(""+b)}).then(function(a){return c._fromRemote(a.data)}),c},c.All=function(){var b;return b=this._MakeCollection(),a({method:"GET",url:this._GetURLBase()}).then(function(a){return function(c){var d,e,f,g;for(g=c.data,e=0,f=g.length;f>e;e++)d=g[e],b.push(a._MakeInstanceFromRemote(d));return b.$_getPromiseForItems().then(function(){return b.$meta.deferred.resolve(b)}),b.$meta.deferred_direct.resolve(b)}}(this)),b},c.Search=function(b,c){var d,e,f;return d=encodeURIComponent(b),e=encodeURIComponent(c),f=""+this.GetUrlBase()+"search/"+d+"/"+e,a({method:"GET",url:f}).then(function(a){return function(b){var c,d,e,f,g;for(f=b.data,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a._MakeInstanceFromRemote(c));return g}}(this))},c.prototype.$save=function(){var b,c,d;return b=this._toObject(),this.$meta.persisted&&null!=this.id?(c="PUT",d=this._getURLBase()+(""+this.id)):(c="POST","id"in b&&delete b.id,d=this._getURLBase()),this._setupPromises(),a({method:c,url:d,data:b,cache:!1}).then(function(a){return function(b){return a._fromRemote(b.data)}}(this)),this},c._MakeCollection=function(){var a;return a=[],a.$meta={model:this,deferred:b.defer(),deferred_direct:b.defer()},a.$promise=a.$meta.deferred.promise,a.$promiseDirect=a.$meta.deferred_direct.promise,a.$getItemsPromises=function(){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.$promise);return e},a.$getItemsPromiseDirects=function(){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.$promiseDirect);return e},a.$_getPromiseForItems=function(){return b.all(a.$getItemsPromises())},a.$_getPromiseDirectForItems=function(){return b.all(a.$getItemsPromiseDirects())},a},c._MakeInstanceFromRemote=function(a){var b;return b=new this,b._fromRemote(a),b},c._GetURLBase=function(){return""+this.urlPrefix+this.urlEndpoint},c.prototype._setupPromises=function(){return this.$meta.$ref_promise=null,this.$meta.$m2m_promise=null,this.$meta.deferred=b.defer(),this.$meta.deferred_direct=b.defer(),this.$promise=b.all([this.$meta.$ref_promise,this.$meta.$m2m_promise]),this.$promiseDirect=this.$meta.deferred_direct.promise,this},c.prototype._getURLBase=function(){return""+this.constructor.urlPrefix+this.constructor.urlEndpoint},c.prototype._fetchRelations=function(){return this._fetchReferences(),this._fetchM2M(),this},c.prototype._fetchReferences=function(){var a,c,d,e,f,g;a=function(a,b,c){var d,e;return d=b.name,d in a&&a[d]?(e=a[d],c.push(b.model.get(e).then(function(b){return a[d]=b,a[""+d+"_id"]=e,a}))):void 0},c=[],g=this.constructor.references;for(e=0,f=g.length;f>e;e++)d=g[e],a(this,d,c);return this.$meta.$ref_promise=b.all(c),this},c.prototype._fetchM2M=function(){var a,c,d,e,f,g;a=function(a,c,d){var e,f,g,h,i,j;if(e=c.name,e in a&&a[e]){for(g=[],j=a[e],h=0,i=j.length;i>h;h++)f=j[h],g.push(c.model.get(f));return d.push(b.all(g).then(function(b){return a[e]=b,a}))}return a[e]=[]},d=[],g=this.constructor.m2m;for(e=0,f=g.length;f>e;e++)c=g[e],a(this,c,d);return this.$meta.$m2m_promise=b.all(d),this},c.prototype._fromRemote=function(a){return this._fromObject(a),this.$meta.persisted=!0,this.$meta.deferred_direct.resolve(this),this._fetchRelations(),this},c.prototype._toObject=function(){var a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q;d={};for(b in this)__hasProp.call(this,b)&&(f=this[b],"$meta"!==b&&"constructor"!==b&&"__proto__"!==b&&(d[b]=f));for(p=this.constructor.references,j=0,m=p.length;m>j;j++)e=p[j],a=e.name,a in d&&(g=d[a],g&&(angular.isObject(g)||g instanceof c)&&(d[a]=null!=g.id?g.id:null));for(q=this.constructor.m2m,k=0,n=q.length;n>k;k++)if(e=q[k],a=e.name,a in d&&(h=d[a])){for(angular.isArray(h)||(h=[h]),i=[],l=0,o=h.length;o>l;l++)g=h[l],i.push(angular.isObject(g)||g instanceof c?null!=g.id?g.id:null:g);d[a]=i}return d},c.prototype._fromObject=function(a){var b,c,d;b=angular.extend({},this.constructor.defaults,a||{});for(c in b)d=b[c],"$meta"!==c&&"constructor"!==c&&"__proto__"!==c&&(this[c]=d);return this.constructor.idField in b&&(this.$id=a[this.constructor.idField]),this},c}()}]);