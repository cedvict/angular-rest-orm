/**
 * Angular ORM for HTTP REST APIs
 * @version angular-rest-orm - v0.3.1 - 2014-09-04
 * @link https://github.com/panta/angular-rest-orm
 * @author Marco Pantaleoni <marco.pantaleoni@gmail.com>
 *
 * Copyright (c) 2014 Marco Pantaleoni <marco.pantaleoni@gmail.com>
 * Licensed under the MIT License, http://opensource.org/licenses/MIT
 */
var __slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};angular.module("restOrm",[]).factory("Resource",["$http","$q",function(a,b){var c,d,e,f,g;return e=function(a,b){return a.slice(0,b.length)===b},d=function(a,b){return""===b||a.slice(-b.length)===b},g=function(){var a,b,c,f,g,h,i,j,k,l,m,n,o;if(c=1<=arguments.length?__slice.call(arguments,0):[],h=function(a){return a.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")},k=[],c&&c.length>0){for(j=0;j<c.length&&!c[j];)++j;j&&(c=c.slice(j))}for(g=null,l=0,n=c.length;n>l;l++)if(b=c[l],null!=b&&b)for(g=b,a=(""+b).split("/"),f=m=0,o=a.length;o>=0?o>m:m>o;f=o>=0?++m:--m)if(".."===a[f])k.pop();else{if("."===a[f]||""===a[f])continue;k.push(a[f])}return i=h(k.join("/")),c&&c.length>=1&&(b=""+c[0],e(b,"//")?i="//"+i:e(b,"/")&&(i="/"+i),g=""+g,d(g,"/")&&!d(i,"/")&&(i+="/")),i},f=function(){return encodeURI(g.apply(null,arguments))},c=function(){function c(a,b){null==a&&(a=null),null==b&&(b={}),this.$meta={persisted:!1,async:{direct:{deferred:null,resolved:!0},m2o:{deferred:null,resolved:!0},m2m:{deferred:null,resolved:!0}}},angular.extend(this.$meta,b),this.$id=null,this._fromObject(a||{}),this.$promise=null,this.$promiseDirect=null,this._setupPromises(),this._fetchRelations(),"function"==typeof this.$initialize&&this.$initialize.apply(this,arguments)}return c.urlPrefix="",c.urlEndpoint="",c.idField="id",c.defaults={},c.references=[],c.m2m=[],c.headers={},c.transformResponse=null,c.include=function(a){var b,c,d;if(!a)throw new Error("include(obj) requires obj");for(b in a)c=a[b],"included"!==b&&"extended"!==b&&(this.prototype[b]=c);return null!=(d=a.included)&&d.apply(this),this},c.extend=function(a){var b,c,d;if(!a)throw new Error("extend(obj) requires obj");for(b in a)c=a[b],"included"!==b&&"extended"!==b&&(this[b]=c);return null!=(d=a.extended)&&d.apply(this),this},c.Subclass=function(a,b){var c;return c=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b}(this),a&&c.include(a),b&&c.extend(b),c.prototype.$super=function(a){return this.constructor.__super__[a]},c},c.Create=function(a,b){var c;return null==a&&(a=null),null==b&&(b={}),a=a||this.defaults,c=new this(a,{persisted:!1}),c.$save(b),c},c.Get=function(b,c){var d,e;return null==c&&(c={}),d=new this,e=f(this._GetURLBase(),b),d._setupPromises(),a({method:"GET",url:e,headers:this._BuildHeaders("Get","GET",null),params:c.params||{},data:c.data||{}}).then(function(a){return function(b){return b=a._TransformResponse(b.data,{what:"Get",method:"GET",url:e,response:b}),d._fromRemote(b.data)}}(this)),d},c.All=function(b){var c,d;return null==b&&(b={}),c=this._MakeCollection(),d=f(this._GetURLBase()),a({method:"GET",url:d,headers:this._BuildHeaders("All","GET",null),params:b.params||{},data:b.data||{}}).then(function(a){return function(b){var e,f,g,h;for(b=a._TransformResponse(b.data,{what:"All",method:"GET",url:d,response:b}),h=b.data,f=0,g=h.length;g>f;f++)e=h[f],c.push(a._MakeInstanceFromRemote(e));return c.$finalize()}}(this)),c},c.Search=function(b,c,d){var e;return null==d&&(d={}),e=f(this.GetUrlBase(),"search",b,c),a({method:"GET",url:e,headers:this._BuildHeaders("Search","GET",null),params:d.params||{},data:d.data||{}}).then(function(a){return function(b){var c,d,f,g,h;for(b=a._TransformResponse(b.data,{what:"Search",method:"GET",url:e,response:b}),g=b.data,h=[],d=0,f=g.length;f>d;d++)c=g[d],h.push(a._MakeInstanceFromRemote(c));return h}}(this))},c.prototype.$save=function(b){var c,d,e,g;return null==b&&(b={}),c=this._toObject(),this.$meta.persisted&&null!=this.$id?(e="PUT",g=f(this._getURLBase(),this.$id)):(e="POST",this.constructor.idField in c&&delete c[this.constructor.idField],g=f(this._getURLBase())),this._setupPromises(),d=this._buildHeaders("$save",e),a({method:e,url:g,data:c,cache:!1,headers:d,params:b.params||{}}).then(function(a){return function(b){return b=a._transformResponse(b.data,{what:"$save",method:e,url:g,response:b}),a._fromRemote(b.data)}}(this)),this},c._MakeCollection=function(){var a;return a=[],a.$meta={model:this,async:{direct:{deferred:b.defer(),resolved:!1},complete:{deferred:b.defer(),resolved:!1}}},a.$promise=a.$meta.async.complete.deferred.promise,a.$promiseDirect=a.$meta.async.direct.deferred.promise,a.$getItemsPromises=function(){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.$promise);return e},a.$getItemsPromiseDirects=function(){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.$promiseDirect);return e},a.$_getPromiseForItems=function(){return b.all(a.$getItemsPromises())},a.$_getPromiseDirectForItems=function(){return b.all(a.$getItemsPromiseDirects())},a.$finalize=function(){return a.$_getPromiseForItems().then(function(){return a.$meta.async.complete.deferred.resolve(a),a.$meta.async.complete.resolved=!0}),a.$meta.async.direct.deferred.resolve(a),a.$meta.async.direct.resolved=!0,a},a},c._MakeInstanceFromRemote=function(a){var b;return b=new this,b._setupPromises(),b._fromRemote(a),b},c._GetURLBase=function(){return g(this.urlPrefix,this.urlEndpoint)},c._BuildHeaders=function(a,b,c){var d,e;return null==a&&(a=null),null==b&&(b=null),null==c&&(c=null),null==this.headers?{}:angular.isFunction(this.headers)?this.headers.call(this,{klass:this,what:a,method:b,instance:c}):angular.isObject(this.headers)?(e=function(d){return function(e,f){var g,h,i;for(h in f)i=f[h],g=angular.isFunction(i)?i.call(d,{klass:d,what:a,method:b,instance:c}):i,null!==g&&(e[h]=g);return e}}(this),d={},"common"in this.headers||null!=a&&a in this.headers||null!=b&&b in this.headers?("common"in this.headers&&e(d,this.headers.common),null!=a&&a in this.headers&&e(d,this.headers[a]),null!=b&&b in this.headers&&e(d,this.headers[b])):e(d,this.headers),d):{}},c._TransformResponse=function(a,b){return b.klass=this,null!=this.transformResponse&&angular.isFunction(this.transformResponse)?this.transformResponse.call(this,a,b):b.response},c.prototype._transformResponse=function(a,b){return b.instance=this,this.constructor._TransformResponse(a,b)},c.prototype._buildHeaders=function(a,b){return null==a&&(a=null),null==b&&(b=null),this.constructor._BuildHeaders(a,b,this)},c.prototype._setupPromises=function(){var a;return a=!1,(this.$meta.async.direct.resolved||null==this.$meta.async.direct.deferred)&&(this.$meta.async.direct.deferred=b.defer(),this.$meta.async.direct.resolved=!1,a=!0,this.$promiseDirect=this.$meta.async.direct.deferred.promise.then(function(a){return function(){return a.$meta.async.direct.resolved=!0,a}}(this))),(this.$meta.async.m2o.resolved||null==this.$meta.async.m2o.deferred)&&(this.$meta.async.m2o.deferred=b.defer(),this.$meta.async.m2o.resolved=!1,a=!0,this.$meta.async.m2o.deferred.promise.then(function(a){return function(){return a.$meta.async.m2o.resolved=!0,a}}(this))),(this.$meta.async.m2m.resolved||null==this.$meta.async.m2m.deferred)&&(this.$meta.async.m2m.deferred=b.defer(),this.$meta.async.m2m.resolved=!1,a=!0,this.$meta.async.m2m.deferred.promise.then(function(a){return function(){return a.$meta.async.m2m.resolved=!0,a}}(this))),a&&(this.$promise=b.all([this.$meta.async.direct.deferred.promise,this.$meta.async.m2o.deferred.promise,this.$meta.async.m2m.deferred.promise]).then(function(a){return function(){return a.$meta.async.direct.resolved=!0,a.$meta.async.m2o.resolved=!0,a.$meta.async.m2m.resolved=!0,a}}(this))),this},c.prototype._getURLBase=function(){return g(this.constructor.urlPrefix,this.constructor.urlEndpoint)},c.prototype._fetchRelations=function(){return this.$id&&(this._fetchReferences(),this._fetchM2M()),this},c.prototype._fetchReferences=function(){var a,c,d,e,f,g;a=function(a,b,c){var d,e,f;return d=b.name,d in a&&a[d]?(f=a[d],e=b.model.Get(f),a[d]=e,c.push(e.$promise)):void 0},c=[],g=this.constructor.references;for(e=0,f=g.length;f>e;e++)d=g[e],a(this,d,c);return b.all(c).then(function(a){return function(){return a.$meta.async.m2o.deferred.resolve(a)}}(this)),this},c.prototype._fetchM2M=function(){var a,c,d,e,f,g;a=function(a,b,c){var d,e,f,g,h,i,j,k;if(d=b.name,d in a&&a[d]){for(h=[],g=b.model._MakeCollection(),k=a[d],i=0,j=k.length;j>i;i++)f=k[i],e=b.model.Get(f),g.push(e),h.push(e.$promise);return a[d]=g,c.push(g.$promise),g.$finalize()}return a[d]=[]},d=[],g=this.constructor.m2m;for(e=0,f=g.length;f>e;e++)c=g[e],a(this,c,d);return b.all(d).then(function(a){return function(){return a.$meta.async.m2m.deferred.resolve(a)}}(this)),this},c.prototype._fromRemote=function(a){return this._fromObject(a),this.$meta.persisted=!0,this.$meta.async.direct.deferred.resolve(this),this._fetchRelations(),this},c.prototype._toObject=function(){var a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q;d={};for(b in this)__hasProp.call(this,b)&&(f=this[b],"$meta"!==b&&"constructor"!==b&&"__proto__"!==b&&(d[b]=f));for(p=this.constructor.references,j=0,m=p.length;m>j;j++)e=p[j],a=e.name,a in d&&(g=d[a],null!=g&&g&&(angular.isObject(g)||g instanceof c)&&(d[a]=null!=g.$id?g.$id:null));for(q=this.constructor.m2m,k=0,n=q.length;n>k;k++)if(e=q[k],a=e.name,a in d&&(h=d[a],null!=h&&h)){for(angular.isArray(h)||(h=[h]),i=[],l=0,o=h.length;o>l;l++)g=h[l],i.push(angular.isObject(g)||g instanceof c?null!=g.$id?g.$id:null:g);d[a]=i}return d},c.prototype._fromObject=function(a){var b,c,d;b=angular.extend({},this.constructor.defaults,a||{});for(c in b)d=b[c],"$id"!==c&&"$meta"!==c&&"constructor"!==c&&"__proto__"!==c&&(this[c]=d);return this.constructor.idField in b&&(this.$id=a[this.constructor.idField]),this},c}()}]);