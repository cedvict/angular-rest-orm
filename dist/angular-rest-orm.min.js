/**
 * Angular ORM for HTTP REST APIs
 * @version angular-rest-orm - v0.4.0 - 2014-09-05
 * @link https://github.com/panta/angular-rest-orm
 * @author Marco Pantaleoni <marco.pantaleoni@gmail.com>
 *
 * Copyright (c) 2014 Marco Pantaleoni <marco.pantaleoni@gmail.com>
 * Licensed under the MIT License, http://opensource.org/licenses/MIT
 */
var __hasProp={}.hasOwnProperty,__slice=[].slice,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};angular.module("restOrm",[]).factory("Resource",["$http","$q",function(a,b){var c,d,e,f,g,h;return e=function(a){var b;if(null==a)return!0;if(a.length>0)return!1;if(0===a.length)return!0;for(b in a)if(__hasProp.call(a,b))return!1;return!0},f=function(a,b){return a.slice(0,b.length)===b},d=function(a,b){return""===b||a.slice(-b.length)===b},h=function(){var a,b,c,e,g,h,i,j,k,l,m,n,o;if(c=1<=arguments.length?__slice.call(arguments,0):[],h=function(a){return a.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")},k=[],c&&c.length>0){for(j=0;j<c.length&&!c[j];)++j;j&&(c=c.slice(j))}for(g=null,l=0,n=c.length;n>l;l++)if(b=c[l],null!=b&&b)for(g=b,a=(""+b).split("/"),e=m=0,o=a.length;o>=0?o>m:m>o;e=o>=0?++m:--m)if(".."===a[e])k.pop();else{if("."===a[e]||""===a[e])continue;k.push(a[e])}return i=h(k.join("/")),c&&c.length>=1&&(b=""+c[0],f(b,"//")?i="//"+i:f(b,"/")&&(i="/"+i),g=""+g,d(g,"/")&&!d(i,"/")&&(i+="/")),i},g=function(){return encodeURI(h.apply(null,arguments))},c=function(){function c(a,b){null==a&&(a=null),null==b&&(b={}),this.$meta={persisted:!1,async:{direct:{deferred:null,resolved:!0},m2o:{deferred:null,resolved:!0},m2m:{deferred:null,resolved:!0}}},angular.extend(this.$meta,b),this.$id=null,this._fromObject(a||{}),this.$promise=null,this.$promiseDirect=null,this._setupPromises(),this._fetchRelations(),"function"==typeof this.$initialize&&this.$initialize.apply(this,arguments)}return c.urlPrefix="",c.urlEndpoint="",c.idField="id",c.fields={},c.defaults={},c.headers={},c.transformResponse=null,c.Reference="reference",c.ManyToMany="many2many",c.include=function(a){var b,c,d;if(!a)throw new Error("include(obj) requires obj");for(b in a)c=a[b],"included"!==b&&"extended"!==b&&(this.prototype[b]=c);return null!=(d=a.included)&&d.apply(this),this},c.extend=function(a){var b,c,d;if(!a)throw new Error("extend(obj) requires obj");for(b in a)c=a[b],"included"!==b&&"extended"!==b&&(this[b]=c);return null!=(d=a.extended)&&d.apply(this),this},c.Subclass=function(a,b){var c;return c=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b}(this),a&&c.include(a),b&&c.extend(b),c.prototype.$super=function(a){return this.constructor.__super__[a]},c},c.Create=function(a,b){var c;return null==a&&(a=null),null==b&&(b={}),a=a||this.defaults,c=new this(a,{persisted:!1}),c.$save(b),c},c.Get=function(b,c){var d,e;return null==c&&(c={}),d=new this,e=g(this._GetURLBase(),b),d._setupPromises(),a({method:"GET",url:e,headers:this._BuildHeaders("Get","GET",null),params:c.params||{},data:c.data||{}}).then(function(a){return function(b){return b=a._TransformResponse(b.data,{what:"Get",method:"GET",url:e,response:b}),d._fromRemote(b.data)}}(this)),d},c.All=function(b){var c,d;return null==b&&(b={}),c=this._MakeCollection(),d=g(this._GetURLBase()),a({method:"GET",url:d,headers:this._BuildHeaders("All","GET",null),params:b.params||{},data:b.data||{}}).then(function(a){return function(b){var e,f,g,h;for(b=a._TransformResponse(b.data,{what:"All",method:"GET",url:d,response:b}),h=b.data,f=0,g=h.length;g>f;f++)e=h[f],c.push(a._MakeInstanceFromRemote(e));return c.$finalize()}}(this)),c},c.Search=function(b,c,d){var e;return null==d&&(d={}),e=g(this.GetUrlBase(),"search",b,c),a({method:"GET",url:e,headers:this._BuildHeaders("Search","GET",null),params:d.params||{},data:d.data||{}}).then(function(a){return function(b){var c,d,f,g,h;for(b=a._TransformResponse(b.data,{what:"Search",method:"GET",url:e,response:b}),g=b.data,h=[],d=0,f=g.length;f>d;d++)c=g[d],h.push(a._MakeInstanceFromRemote(c));return h}}(this))},c.prototype.$save=function(b){var c,d,e,f;return null==b&&(b={}),c=this._toRemoteObject(),this.$meta.persisted&&null!=this.$id?(e="PUT",f=g(this._getURLBase(),this.$id)):(e="POST",this.constructor.idField in c&&delete c[this.constructor.idField],f=g(this._getURLBase())),this._setupPromises(),d=this._buildHeaders("$save",e),a({method:e,url:f,data:c,cache:!1,headers:d,params:b.params||{}}).then(function(a){return function(b){return b=a._transformResponse(b.data,{what:"$save",method:e,url:f,response:b}),a._fromRemote(b.data)}}(this)),this},c._MakeCollection=function(){var a;return a=[],a.$meta={model:this,async:{direct:{deferred:b.defer(),resolved:!1},complete:{deferred:b.defer(),resolved:!1}}},a.$promise=a.$meta.async.complete.deferred.promise,a.$promiseDirect=a.$meta.async.direct.deferred.promise,a.$getItemsPromises=function(){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.$promise);return e},a.$getItemsPromiseDirects=function(){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.$promiseDirect);return e},a.$_getPromiseForItems=function(){return b.all(a.$getItemsPromises())},a.$_getPromiseDirectForItems=function(){return b.all(a.$getItemsPromiseDirects())},a.$finalize=function(){return a.$_getPromiseForItems().then(function(){return a.$meta.async.complete.deferred.resolve(a),a.$meta.async.complete.resolved=!0}),a.$meta.async.direct.deferred.resolve(a),a.$meta.async.direct.resolved=!0,a},a},c._MakeInstanceFromRemote=function(a){var b;return b=new this,b._setupPromises(),b._fromRemote(a),b},c._GetURLBase=function(){return h(this.urlPrefix,this.urlEndpoint)},c._BuildHeaders=function(a,b,c){var d,e;return null==a&&(a=null),null==b&&(b=null),null==c&&(c=null),null==this.headers?{}:angular.isFunction(this.headers)?this.headers.call(this,{klass:this,what:a,method:b,instance:c}):angular.isObject(this.headers)?(e=function(d){return function(e,f){var g,h,i;for(h in f)i=f[h],g=angular.isFunction(i)?i.call(d,{klass:d,what:a,method:b,instance:c}):i,null!==g&&(e[h]=g);return e}}(this),d={},"common"in this.headers||null!=a&&a in this.headers||null!=b&&b in this.headers?("common"in this.headers&&e(d,this.headers.common),null!=a&&a in this.headers&&e(d,this.headers[a]),null!=b&&b in this.headers&&e(d,this.headers[b])):e(d,this.headers),d):{}},c._TransformResponse=function(a,b){return b.klass=this,null!=this.transformResponse&&angular.isFunction(this.transformResponse)?this.transformResponse.call(this,a,b):b.response},c.prototype._transformResponse=function(a,b){return b.instance=this,this.constructor._TransformResponse(a,b)},c.prototype._buildHeaders=function(a,b){return null==a&&(a=null),null==b&&(b=null),this.constructor._BuildHeaders(a,b,this)},c.prototype._setupPromises=function(){var a;return a=!1,(this.$meta.async.direct.resolved||null==this.$meta.async.direct.deferred)&&(this.$meta.async.direct.deferred=b.defer(),this.$meta.async.direct.resolved=!1,a=!0,this.$promiseDirect=this.$meta.async.direct.deferred.promise.then(function(a){return function(){return a.$meta.async.direct.resolved=!0,a}}(this))),(this.$meta.async.m2o.resolved||null==this.$meta.async.m2o.deferred)&&(this.$meta.async.m2o.deferred=b.defer(),this.$meta.async.m2o.resolved=!1,a=!0,this.$meta.async.m2o.deferred.promise.then(function(a){return function(){return a.$meta.async.m2o.resolved=!0,a}}(this))),(this.$meta.async.m2m.resolved||null==this.$meta.async.m2m.deferred)&&(this.$meta.async.m2m.deferred=b.defer(),this.$meta.async.m2m.resolved=!1,a=!0,this.$meta.async.m2m.deferred.promise.then(function(a){return function(){return a.$meta.async.m2m.resolved=!0,a}}(this))),a&&(this.$promise=b.all([this.$meta.async.direct.deferred.promise,this.$meta.async.m2o.deferred.promise,this.$meta.async.m2m.deferred.promise]).then(function(a){return function(){return a.$meta.async.direct.resolved=!0,a.$meta.async.m2o.resolved=!0,a.$meta.async.m2m.resolved=!0,a}}(this))),this},c.prototype._getURLBase=function(){return h(this.constructor.urlPrefix,this.constructor.urlEndpoint)},c.prototype._fetchRelations=function(){return this.$id&&(this._fetchReferences(),this._fetchM2M()),this},c.prototype._fetchReferences=function(){var a,c,d,e;c=function(a,b,c){var d,e,f;return d=b.name,d in a&&a[d]?(f=a[d],e=b.model.Get(f),a[d]=e,c.push(e.$promise)):void 0},e=[];for(d in this.constructor.fields)a=this._getField(d),a.type===this.constructor.Reference&&c(this,a,e);return b.all(e).then(function(a){return function(){return a.$meta.async.m2o.deferred.resolve(a)}}(this)),this},c.prototype._fetchM2M=function(){var a,c,d,e;c=function(a,b,c){var d,e,f,g,h,i,j,k;if(d=b.name,d in a&&a[d]){for(h=[],g=b.model._MakeCollection(),k=a[d],i=0,j=k.length;j>i;i++)f=k[i],e=b.model.Get(f),g.push(e),h.push(e.$promise);return a[d]=g,c.push(g.$promise),g.$finalize()}return a[d]=[]},e=[];for(d in this.constructor.fields)a=this._getField(d),a.type===this.constructor.ManyToMany&&c(this,a,e);return b.all(e).then(function(a){return function(){return a.$meta.async.m2m.deferred.resolve(a)}}(this)),this},c.prototype._fromRemote=function(a){return this._fromRemoteObject(a),this.$meta.persisted=!0,this.$meta.async.direct.deferred.resolve(this),this._fetchRelations(),this},c.prototype._getField=function(a){var b;return b={name:a,remote:a,type:null,model:null},a in this.constructor.fields?angular.extend(b,this.constructor.fields[a]||{}):b},c.prototype._toObject=function(){var a,b,d,e,f,g,h,i;d={};for(b in this)if(__hasProp.call(this,b)&&(f=this[b],"$id"!==b&&"$meta"!==b&&"constructor"!==b&&"__proto__"!==b&&(a=this._getField(b),d[b]=f,f)))if(a.type===this.constructor.Reference)(angular.isObject(f)||f instanceof c)&&(d[b]=null!=f.$id?f.$id:null);else if(a.type===this.constructor.ManyToMany){for(g=angular.isArray(f)?f:[f],e=[],h=0,i=g.length;i>h;h++)f=g[h],e.push(angular.isObject(f)||f instanceof c?null!=f.$id?f.$id:null:f);d[b]=e}return d},c.prototype._fromObject=function(a){var b,c,d,e;b=angular.extend({},this.constructor.defaults,a||{});for(d in b)e=b[d],"$id"!==d&&"$meta"!==d&&"constructor"!==d&&"__proto__"!==d&&(this[d]=e);for(d in this.constructor.fields)c=this._getField(d),"$id"!==d&&"$meta"!==d&&"constructor"!==d&&"__proto__"!==d&&!(d in b)&&"default"in c&&(this[d]=c["default"]);return this},c.prototype._toRemoteObject=function(){var a,b,d,e,f,g,h,i;d={};for(b in this)if(__hasProp.call(this,b)&&(f=this[b],"$id"!==b&&"$meta"!==b&&"constructor"!==b&&"__proto__"!==b&&(a=this._getField(b),d[a.remote]=f,f)))if(a.type===this.constructor.Reference)(angular.isObject(f)||f instanceof c)&&(d[a.remote]=null!=f.$id?f.$id:null);else if(a.type===this.constructor.ManyToMany){for(g=angular.isArray(f)?f:[f],e=[],h=0,i=g.length;i>h;h++)f=g[h],e.push(angular.isObject(f)||f instanceof c?null!=f.$id?f.$id:null:f);d[a.remote]=e}return d},c.prototype._fromRemoteObject=function(a){var b,c,d,f,g;if(e(this.constructor.fields)){b=angular.extend({},this.constructor.defaults,a||{});for(d in b)f=b[d],"$id"!==d&&"$meta"!==d&&"constructor"!==d&&"__proto__"!==d&&(this[d]=f)}else{b=angular.extend({},a||{});for(d in this.constructor.fields)c=this._getField(d),"$id"!==d&&"$meta"!==d&&"constructor"!==d&&"__proto__"!==d&&(c.remote in b?this[d]=b[c.remote]:"default"in c&&(this[d]=c["default"]));g=this.constructor.defaults;for(d in g)f=g[d],d in this||(this[d]=f)}return this.constructor.idField in b&&(this.$id=a[this.constructor.idField]),this},c}()}]);